<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
<title>word2vec Demo</title>
<!-- Bootstrap -->
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="bootstrap/bootstrap.min.css">
<link rel="stylesheet" href="d3_app.css">
<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

<!-- https://dev.twitter.com/web/javascript/loading -->
<!-- Check out this handy way of embeddin tweets: https://dev.twitter.com/web/embedded-tweets/javascript-create -->
<script src="http://d3js.org/d3.v4.min.js"></script>

<script type="text/javascript" src="db.js"></script>
<script type="text/javascript" src="search.js"></script>
<script type="text/javascript" src="bootstrap/numjs.min.js"></script>
<script type="text/javascript" src="filter.js"></script>

<script
src="https://code.jquery.com/jquery-2.1.3.min.js"
integrity="sha256-ivk71nXhz9nsyFDoYoGf2sbjrR9ddh+XDkCcfZxjvcM="
crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.12.2/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sprintf/1.1.1/sprintf.min.js"></script>

<style>
.d {
  display: inline-block;
}
</style>

<script>

// http://stackoverflow.com/questions/5199901/how-to-sort-an-associative-array-by-its-values-in-javascript
function logResults(results, k) {
  document.getElementById('results').innerHTML = "";

  for (var i = 0; i < results.length; i++) {
  var para = document.createElement('p');
  para.appendChild(document.createTextNode('vector for \"' + results[i][0] + '\"\n' + results[i][1]));
  para.className = 'wordvec';
  document.getElementById('results').appendChild(para);
  }
}

searcher.setNumDocs(1128929);

// Querying

function searchButton() {
  //var q = document.querySelector("#query").value.split(" ");
  var q = "no movement , no yuks , not much of anything .".split(" ");

  q = q.map(function(x) { return x.toLowerCase()})
           .filter(function(x) { return x.length > 0 ? true : false; });

  // Perform wordvec retrieval and twitter search
  searcher.search(q, function(results) {
    console.log("Results for: " + q);
    //logResults(results);
    display_conv(results, q);
  });
}

function storeToDB(i, item) {
  var transaction = db.transaction(["nn_res"], "readwrite");
  var store = transaction.objectStore("nn_res");
  var itemFinal = {"value": item}
  var request = store.put(i, itemFinal);
}

var nn_res = [];
function setup(i) {
  // var e = document.getElementById("filter");
  // var selected = e.options[e.selectedIndex].value;
  if (i == 200) {
    console.log("setup finished");
    return;
  } else if (i % 10 == 0) {
    console.log("currently executing: " + i);
  }

  searcher.getSentence(function(sentence, label) {
    var q = sentence.split(" ");

    q = q.map(function(x) { return x.toLowerCase()})
             .filter(function(x) { return x.length > 0 ? true : false; });

    searcher.getBias("bias_3", function(bias_3) {
       searcher.getBias("bias_4", function(bias_4) {
         searcher.getBias("bias_5", function(bias_5) {

           searcher.getWeights("weights_3", function(weights_3) {
             searcher.getWeights("weights_4", function(weights_4) {
               searcher.getWeights("weights_5", function(weights_5) {

                  searcher.getBias("bias_fc1", function(bias_fc1) {
                    searcher.getWeights("weights_fc1", function(weights_fc1) {
                      var weights = Array(weights_3, weights_4, weights_5);
                      var bias = Array(bias_3, bias_4, bias_5);

                      searcher.showVecs(q, function(results) {
                        var ret = display_conv(label, results, q, weights, bias, weights_fc1, bias_fc1);
                        //storeToDB(i, ret);
                        if (ret != undefined) {
                          nn_res[i] = ret;
                          setup(i+1);
                        } else {
                          setup(i);
                        }
                      })
                    })
                  })

                })
              })
            })

         })
       })
     })

  })

}

function showAll() {
  document.getElementById("sent").innerHTML = "";
  //var nn_res = getAll();
  for (var i = 0; i < nn_res.length; i++) {
    var draw = nn_res[i][0];
    display_sentence_coloring(draw[0], draw[1], draw[2], [-1, -1], false);
  }
}

function byFilter() {
  document.getElementById("sent").innerHTML = "";
  // var e = document.getElementById("filter");
  // var selected = e.options[e.selectedIndex].value;
  //var nn_res = getAll();
  var groupByFilter = []; // 3*100
  for (var d = 0; d < 3; d++) {
    groupByFilter[d] = [];
    for (var f = 0; f < 100; f++) {
      groupByFilter[d][f] = []; // 3*100*#sentenses*2
    }
  }

  for (var i = 0; i < nn_res.length; i++) {  // number of sentences analyzed
    var toDraw = nn_res[i][0];
    var conv_res = nn_res[i][1];
    var max_poll_res = nn_res[i][2];
    for (var d = 0; d < 3; d++) {
      for (var f = 0; f < 100; f++) {
        groupByFilter[d][f][i] = [max_poll_res[d][1][f][0], i]; // dth/3 dim, fth/100 filter
      }
    }
  }

  for (var d = 0; d < 3; d++) {
    for (var f = 0; f < 100; f++) {
      (groupByFilter[d][f]).sort(function(a, b){return b[0]-a[0]});
    }
  }

  var prev_d = -1;
  var prev_f = -1;
  for (var d = 0; d < 3; d++) {
    for (var f = 0; f < 100; f++) {
      for (var k = 0; k < 10; k++) {
        var index = groupByFilter[d][f][k][1];
        var draw = nn_res[index][0];
        var conv_res = nn_res[index][1];
        var max_poll_res = nn_res[index][2];

        var matchedIndex = filter_max_index(max_poll_res);
        var idx = matchedIndex[d][f];
        if (d == 0) {
          idx -= 2;
        } else if (d == 1) {
          idx -= 3;
        } else {
          idx -= 4;
        }
        var len = draw[0].length;
        var highlight = [];
        for (var i = 0; i < len; i++) {
          highlight[highlight.length] = [draw[0][i][0], 0];
        }

        var dim = d+3;
        for (var p = 0; p < dim; p++) {
          if (idx+p < 0 || idx+p >= len-1) {
            continue;
          }
          highlight[idx+p][1] = 1;
        }

        if (d != prev_d || f != prev_f) {
          display_sentence_coloring(highlight, draw[1], draw[2], [d, f], true);
          prev_d = d;
          prev_f = f;
        } else {
          display_sentence_coloring(highlight, draw[1], draw[2], [-1,-1], true);
        }
      }
    }
  }

}

window.test = function(e) {
  if (e.value === 'showAll') {
    document.getElementById("results").innerHTML = "";
    // nextButton()
  } else if (e.value === 'byFilter') {
    console.log(e.value);
  }
}

</script>

<style>
body {
  padding-top: 50px;
}
p.wordvec {
  border: 2px solid #A33;
  background-color: #ECC;
  padding: 20px;
  color: black;
  overflow: scroll;
}
</style>

</head>
<body>

  <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="./index.html">word2vec</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li><a href="./index.html">Home</a></li>
            <li><a href="./indexing-demo.html">Demo: Indexing</a></li>
            <li><a href="./search-demo.html">Demo: Search</a></li>
            <li><a href="./kimcnn-demo.html">Demo: Kim CNN</a></li>
            <li class="active"><a href="./filter-demo.html">Demo: Filter</a></li>
            <li><a href="https://github.com/lafh/word2vec">Code (GitHub)</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

<div class="container">

<div class="page-header">
<h1>word2vec <small>Filter Demo</small></h1>
</div>

<p>The following demo searches word2vecs.
Be sure to <a href="indexing-demo.html">build the index</a> first!</p>

<button id="setupButton" onclick="setup(0)">Setup</button>
<button id="showAll" onclick="showAll()">Show All</button>
<button id="byFilter" onclick="byFilter()">By Filter</button>
<select id="filter" onchange="test(this);">
  <option value="showAll">Show All</option>
  <option value="byFilter">By Filter</option>
</select>
</p>

<div id="results" style="padding-bottom: 50px">
  <div class="sentences" id="sent"></div>
</div>

</div>


<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="bootstrap/jquery.min.js"></script>
<script src="bootstrap/bootstrap.min.js"></script>
<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="bootstrap/ie10-viewport-bug-workaround.js"></script>
<script src="d3_app.js"></script>
</body>
</html>
